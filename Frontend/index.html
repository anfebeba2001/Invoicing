<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Billing System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .modal {
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s ease, visibility 0s linear 0.3s;
        }

        .modal.is-active {
            visibility: visible;
            opacity: 1;
            transition-delay: 0s;
        }
    </style>
</head>

<body class="antialiased text-gray-800 text-sm">
    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-900">System Dashboard</h1>
        </header>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div>
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-900">Sales History</h2><button id="addSaleBtn"
                        class="bg-blue-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-blue-700"><i
                            class="fa fa-plus mr-2"></i>Add Sale</button>
                </div>
                <main class="bg-white rounded-xl shadow-md overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-gray-50 border-b">
                                <tr>
                                    <th class="px-4 py-2 text-xs font-semibold text-gray-600 uppercase">Date</th>
                                    <th class="px-4 py-2 text-xs font-semibold text-gray-600 uppercase">Customer</th>
                                    <th class="px-4 py-2 text-xs font-semibold text-gray-600 uppercase">Products</th>
                                    <th class="px-4 py-2 text-xs font-semibold text-gray-600 uppercase">Total</th>
                                </tr>
                            </thead>
                            <tbody id="salesTableBody" class="divide-y"></tbody>
                        </table>
                    </div>
                </main>
            </div>
            <div>
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-900">Product Inventory</h2>
                    <div class="flex space-x-2"><button id="restockBtn"
                            class="bg-green-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-green-700"><i
                                class="fa fa-box mr-2"></i>Restock</button><button id="addProductBtn"
                            class="bg-blue-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-blue-700"><i
                                class="fa fa-plus mr-2"></i>Add Product</button></div>
                </div>
                <main class="bg-white rounded-xl shadow-md overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-gray-50 border-b">
                                <tr>
                                    <th class="px-4 py-2 text-xs font-semibold text-gray-600 uppercase">Name</th>
                                    <th class="px-4 py-2 text-xs font-semibold text-gray-600 uppercase">Manufacturer
                                    </th>
                                    <th class="px-4 py-2 text-xs font-semibold text-gray-600 uppercase">Price</th>
                                    <th class="px-4 py-2 text-xs font-semibold text-gray-600 uppercase">In Stock</th>
                                </tr>
                            </thead>
                            <tbody id="productsTableBody" class="divide-y"></tbody>
                        </table>
                    </div>
                </main>
            </div>
        </div>
    </div>

    <div id="addSaleModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col"
            onclick="event.stopPropagation()">
            <div class="flex justify-between items-center p-5 border-b">
                <h2 class="text-xl font-bold">Register New Sale</h2><button
                    class="close-modal-btn text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <form id="addSaleForm" class="p-6 flex-grow overflow-y-auto">
                <div class="mb-6"><label for="customerName"
                        class="block text-sm font-medium text-gray-700 mb-1">Customer Name</label><input type="text"
                        id="customerName" name="customerName" required
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg"></div>
                <h3 class="text-lg font-semibold mb-3">Products</h3>
                <div id="productEntriesContainer" class="space-y-4"></div><button type="button" id="addProductEntryBtn"
                    class="mt-4 text-blue-600 font-semibold hover:text-blue-800"><i
                        class="fa fa-plus-circle mr-2"></i>Add another product</button>
            </form>
            <div class="flex justify-end items-center p-5 border-t bg-gray-50"><button type="button"
                    class="cancel-modal-btn bg-gray-200 font-semibold px-4 py-2 rounded-lg mr-3">Cancel</button><button
                    type="submit" form="addSaleForm"
                    class="bg-blue-600 text-white font-semibold px-4 py-2 rounded-lg">Save Sale</button></div>
        </div>
    </div>
    <div id="addProductModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg flex flex-col" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center p-5 border-b">
                <h2 class="text-xl font-bold">Add New Product</h2><button
                    class="close-modal-btn text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <form id="addProductForm" class="p-6 space-y-4">
                <div><label class="block text-sm font-medium mb-1">Name</label><input type="text" name="name" required
                        class="w-full px-3 py-2 border rounded-lg"></div>
                <div><label class="block text-sm font-medium mb-1">Manufacturer</label><input type="text"
                        name="manufacturer" required class="w-full px-3 py-2 border rounded-lg"></div>
                <div><label class="block text-sm font-medium mb-1">Price</label><input type="number" name="price"
                        required min="0" step="1" class="w-full px-3 py-2 border rounded-lg"></div>
                <div><label class="block text-sm font-medium mb-1">Amount in Stock</label><input type="number"
                        name="amountInStock" required min="0" class="w-full px-3 py-2 border rounded-lg"></div>
            </form>
            <div class="flex justify-end items-center p-5 border-t bg-gray-50"><button type="button"
                    class="cancel-modal-btn bg-gray-200 font-semibold px-4 py-2 rounded-lg mr-3">Cancel</button><button
                    type="submit" form="addProductForm"
                    class="bg-blue-600 text-white font-semibold px-4 py-2 rounded-lg">Save Product</button></div>
        </div>
    </div>
    <div id="restockModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg flex flex-col" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center p-5 border-b">
                <h2 class="text-xl font-bold">Restock Product</h2><button
                    class="close-modal-btn text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <form id="restockForm" class="p-6 space-y-4">
                <div><label class="block text-sm font-medium mb-1">Product</label><select name="productId"
                        id="restockProductSelect" required class="w-full px-3 py-2 border rounded-lg"></select></div>
                <div><label class="block text-sm font-medium mb-1">Quantity to Add</label><input type="number"
                        name="amount" required min="1" class="w-full px-3 py-2 border rounded-lg"></div>
            </form>
            <div class="flex justify-end items-center p-5 border-t bg-gray-50"><button type="button"
                    class="cancel-modal-btn bg-gray-200 font-semibold px-4 py-2 rounded-lg mr-3">Cancel</button><button
                    type="submit" form="restockForm"
                    class="bg-green-600 text-white font-semibold px-4 py-2 rounded-lg">Restock</button></div>
        </div>
    </div>

    <script>
        const App = {
            state: { sales: [], availableProducts: [] },
            validation: {
                isAlphaWithSpaces(value, fieldName) { if (!/^[A-Za-z\s]+$/.test(value)) { throw new Error(`${fieldName} must contain only letters and spaces.`); } return value; },
                isPositiveNumber(value, fieldName) { const num = Number(value); if (isNaN(num) || num < 0) { throw new Error(`${fieldName} must be a non-negative number.`); } return num; },
                isStrictlyPositiveNumber(value, fieldName) { const num = Number(value); if (isNaN(num) || num <= 0) { throw new Error(`${fieldName} must be a positive number.`); } return num; }
            },
            api: {
                BASE_URL: 'http://localhost:8080/v1/api',
                async fetchData(endpoint) {
                    try {
                        const response = await fetch(`${this.BASE_URL}/${endpoint}`);
                        if (!response.ok) throw new Error(`Could not load ${endpoint}.`);
                        return await response.json();
                    } catch (error) {
                        alert(`Failed to fetch data: ${error.message}`);
                        return [];
                    }
                },
                async sendData(endpoint, data, method = 'POST') {
                    const response = await fetch(`${this.BASE_URL}/${endpoint}`, {
                        method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data),
                    });

                    if (response.ok) return (await response.text()) || 'Operation successful!';

                    let errorMessage = `Request failed: ${response.statusText}`;
                    try {
                        const errorJson = await response.json();
                        errorMessage = errorJson.message || errorMessage;
                    } catch (e) {
                        const errorText = await response.text();
                        errorMessage = errorText || errorMessage;
                    }
                    throw new Error(errorMessage);
                }
            },
            components: {
                createSaleRow: sale => `<tr class="hover:bg-gray-50"><td class="px-4 py-3">${sale.date}</td><td class="px-4 py-3">${sale.customer}</td><td class="px-4 py-3">${sale.products?.length ? (sale.products.length === 1 ? sale.products[0].name : `${sale.products[0].name} & others`) : "N/A"}</td><td class="px-4 py-3 font-medium">${new Intl.NumberFormat("en-US", { style: "currency", currency: "USD", minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(sale.totalValue)}</td></tr>`,
                createProductRow: p => `<tr class="hover:bg-gray-50"><td class="px-4 py-3 font-medium">${p.name}</td><td class="px-4 py-3">${p.manufacturer}</td><td class="px-4 py-3">${new Intl.NumberFormat("en-US", { style: "currency", currency: "USD", minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(p.price)}</td><td class="px-4 py-3">${p.amountInStock}</td></tr>`,
                createProductEntry() {
                    const entryId = Date.now();
                    const div = document.createElement("div");
                    let productOptions = '<option value="" disabled selected>Select a product</option>';
                    App.state.availableProducts.forEach(p => { productOptions += `<option value="${p.id}">${p.name} - $${Math.floor(p.price)}</option>` });
                    div.className = "flex items-center space-x-3 p-3 bg-gray-50 rounded-lg";
                    div.setAttribute("data-id", entryId);
                    div.innerHTML = `<div class="flex-grow"><select name="productId" required class="w-full px-3 py-2 border rounded-lg">${productOptions}</select></div><div class="w-24"><input type="number" name="quantity" required min="1" placeholder="Qty." class="w-full px-3 py-2 border rounded-lg"></div><button type="button" class="text-red-500 hover:text-red-700"><i class="fa fa-trash-alt"></i></button>`;
                    div.querySelector("button").addEventListener("click", () => App.handlers.handleRemoveProductEntry(entryId));
                    return div;
                }
            },
            ui: {
                elements: {},
                cacheDOMElements() {
                    const ids = ['salesTableBody', 'productsTableBody', 'addSaleModal', 'addProductModal', 'restockModal', 'addSaleForm', 'addProductForm', 'restockForm', 'productEntriesContainer', 'addSaleBtn', 'addProductBtn', 'restockBtn', 'addProductEntryBtn', 'restockProductSelect'];
                    ids.forEach(id => this.elements[id] = document.getElementById(id));
                    this.elements.closeModalBtns = document.querySelectorAll('.close-modal-btn');
                    this.elements.cancelModalBtns = document.querySelectorAll('.cancel-modal-btn');
                },
                renderTable(tableBody, items, rowComponent, noDataMessage) {
                    tableBody.innerHTML = items.length ? items.map(rowComponent).join("") : `<tr><td colspan="4" class="text-center p-8 text-gray-500">${noDataMessage}</td></tr>`;
                },
                toggleModal(modal, show) {
                    if (show) modal.classList.add('is-active');
                    else modal.classList.remove('is-active');
                },
                populateRestockDropdown() {
                    const select = this.elements.restockProductSelect;
                    select.innerHTML = '<option value="" disabled selected>Select a product</option>';
                    App.state.availableProducts.forEach(p => { select.innerHTML += `<option value="${p.id}">${p.name} (Stock: ${p.amountInStock})</option>` });
                }
            },
            handlers: {
                async handleFormSubmit(event, modal, apiCall, getData) {
                    event.preventDefault();
                    try {
                        const data = getData(event.target);
                        const successMessage = await apiCall(data);
                        App.ui.toggleModal(modal, false);
                        alert(successMessage);
                        await App.initData();
                    } catch (error) {
                        alert(error.message);
                    }
                },
                handleRemoveProductEntry(entryId) {
                    const entry = document.querySelector(`div[data-id='${entryId}']`);
                    if (entry) entry.remove();
                    if (App.ui.elements.productEntriesContainer.children.length === 0) {
                        App.ui.elements.productEntriesContainer.appendChild(App.components.createProductEntry());
                    }
                }
            },
            async initData() {
                const [sales, products] = await Promise.all([this.api.fetchData('sales'), this.api.fetchData('products')]);
                
                // *** INICIO: CAMBIO PARA ORDENAR LOS REGISTROS ***
                // Se usa .reverse() para mostrar los elementos más nuevos primero.
                this.state.sales = sales.reverse();
                this.state.availableProducts = products.reverse();
                // *** FIN: CAMBIO PARA ORDENAR LOS REGISTROS ***
                
                this.ui.renderTable(this.ui.elements.salesTableBody, this.state.sales, this.components.createSaleRow, 'No sales found.');
                this.ui.renderTable(this.ui.elements.productsTableBody, this.state.availableProducts, this.components.createProductRow, 'No products found.');
            },
            init() {
                this.ui.cacheDOMElements();
                const { elements: e } = this.ui;

                e.addSaleBtn.addEventListener("click", () => { this.ui.toggleModal(e.addSaleModal, true); if (e.productEntriesContainer.children.length === 0) e.productEntriesContainer.appendChild(this.components.createProductEntry()) });
                e.addProductBtn.addEventListener("click", () => this.ui.toggleModal(e.addProductModal, true));
                e.restockBtn.addEventListener("click", () => { this.ui.populateRestockDropdown(); this.ui.toggleModal(e.restockModal, true) });

                const allModals = [e.addSaleModal, e.addProductModal, e.restockModal];
                e.closeModalBtns.forEach(btn => btn.addEventListener("click", () => allModals.forEach(modal => this.ui.toggleModal(modal, false))));
                e.cancelModalBtns.forEach(btn => btn.addEventListener("click", () => allModals.forEach(modal => this.ui.toggleModal(modal, false))));
                allModals.forEach(modal => modal.addEventListener("click", event => event.target === modal && this.ui.toggleModal(modal, false)));

                e.addSaleForm.addEventListener("submit", t => this.handlers.handleFormSubmit(t, e.addSaleModal, data => this.api.sendData("sales", data, "POST"), form => {
                    const formData = new FormData(form);
                    const customerName = this.validation.isAlphaWithSpaces(formData.get('customerName'), 'Customer Name');
                    const saleData = {
                        customer: customerName,
                        products: Array.from(e.productEntriesContainer.children).map(entry => ({
                            productId: parseInt(entry.querySelector('[name="productId"]').value, 10),
                            quantity: this.validation.isStrictlyPositiveNumber(entry.querySelector('[name="quantity"]').value, 'Quantity')
                        }))
                    };
                    if (saleData.products.some(p => isNaN(p.productId))) throw new Error("Please select a product for all entries.");
                    return saleData;
                }));

                e.addProductForm.addEventListener("submit", t => this.handlers.handleFormSubmit(t, e.addProductModal, data => this.api.sendData("products", data, "POST"), form => {
                    const formData = new FormData(form);
                    return {
                        name: this.validation.isAlphaWithSpaces(formData.get('name'), 'Name'),
                        manufacturer: this.validation.isAlphaWithSpaces(formData.get('manufacturer'), 'Manufacturer'),
                        price: this.validation.isPositiveNumber(formData.get('price'), 'Price'),
                        amountInStock: this.validation.isPositiveNumber(formData.get('amountInStock'), 'Amount in Stock')
                    };
                }));

                e.restockForm.addEventListener("submit", t => this.handlers.handleFormSubmit(t, e.restockModal, data => this.api.sendData("products", data, "PATCH"), form => {
                    const formData = new FormData(form);
                    return {
                        productId: formData.get('productId'),
                        amount: this.validation.isStrictlyPositiveNumber(formData.get('amount'), 'Quantity to Add')
                    };
                }));

                e.addProductEntryBtn.addEventListener("click", () => e.productEntriesContainer.appendChild(this.components.createProductEntry()));
                this.initData();
            }
        };
        document.addEventListener('DOMContentLoaded', () => App.init());
    </script>
</body>

</html>